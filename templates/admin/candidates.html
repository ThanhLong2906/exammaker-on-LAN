<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω th√≠ sinh</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 60px auto 60px;
            max-width: 1200px;
            background: url('/static/img/Background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            min-height: 100vh;
        }

        header {
            display: flex;
            align-items: center;
            background: #003200;
            padding: 10px 20px;
            border-bottom: 3px solid yellow;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
        }

        header img {
            height: 80px;
            margin-right: 15px;
        }

        header h1 {
            margin: 0;
            font-size: 25px;
            font-weight: bold;
            color: yellow;
        }

        header p {
            margin: 0;
            font-size: 18px;
            font-style: italic;
            color: #ffcc00;
        }

        footer {
            background: #003200;
            text-align: center;
            padding: 10px;
            color: #ccc;
            font-size: 14px;
            border-top: 3px solid yellow;
            position: fixed;
            bottom: 0; left: 0; right: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border: 1px solid #555;
            text-align: left;
        }

        th {
            background: #004400;
        }

        tr {
            background: #002200;
        }

        .btn {
            padding: 8px 14px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .btn-add {
            background: yellow;
            color: black;
        }

        .btn-import {
            background: lightgreen;
            color: black;
        }

        .btn-delete {
            background: red;
            color: white;
            padding: 5px 10px;
        }

        .btn-password {
            padding: 5px 10px;
            background: orange;
            color: black;
        }

        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .modal-box {
            background: #003300;
            padding: 20px;
            border-radius: 10px;
            width: 370px;
            color: white;
        }

        .modal-box input {
            width: 100%;
            padding: 7px;
            margin-top: 5px;
            margin-bottom: 10px;
        }

        .modal-footer {
            text-align: right;
        }
    </style>
</head>

<body>

<header>
    <img src="/static/img/LOGO_f395.png" alt="Logo">
    <div>
        <h1>S∆Ø ƒêO√ÄN B·ªò BINH 395</h1>
        <p>‚Äúƒêo√†n k·∫øt, ti·∫øn c√¥ng, luy·ªán gi·ªèi, ƒë√°nh th·∫Øng‚Äù</p>
    </div>
</header>

<h2 style="text-align:center; color:yellow; margin-top:20px;">
    Danh s√°ch th√≠ sinh ‚Äì Cu·ªôc thi ID: {{ comp_id }}
</h2>

<div style="background:#002200; padding:20px; border-radius:10px; margin-top:30px;">

    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <div>
            <button class="btn btn-add" onclick="openAddModal()">‚ûï Th√™m th√≠ sinh</button>
            <button class="btn btn-import" onclick="openImportModal()">üì• Nh·∫≠p t·ª´ Excel</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>H·ªç t√™n</th>
                <th>C·∫•p b·∫≠c</th>
                <th>Ch·ª©c v·ª•</th>
                <th>ƒê∆°n v·ªã</th>
                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>

        <tbody>
            {% if candidates %}
                {% for c in candidates %}
                <tr>
                    <td>{{ c[0] }}</td>
                    <td>{{ c[1] }}</td>
                    <td>{{ c[2] }}</td>
                    <td>{{ c[3] }}</td>
                    <td>{{ c[4] }}</td>
                    <td>{{ c[5] }}</td>
                    <td>
                        <button class="btn-password" onclick="openPasswordModal({{ c[0] }}, '{{ c[5] }}')">üîë M·∫≠t kh·∫©u</button>
                        <button class="btn-delete" onclick="deleteCandidate({{ c[0] }}, '{{ c[5] }}')">üóë X√≥a</button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="7" style="text-align:center;"><i>Ch∆∞a c√≥ th√≠ sinh</i></td></tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- =========================== MODAL TH√äM TH√ç SINH =============================== -->
<div id="addModal" class="modal-bg">
    <div class="modal-box">
        <h3 style="color:yellow;">Th√™m th√≠ sinh</h3>

        <input id="full_name" placeholder="H·ªç t√™n">
        <input id="rank" placeholder="C·∫•p b·∫≠c">
        <input id="position" placeholder="Ch·ª©c v·ª•">
        <input id="unit" placeholder="ƒê∆°n v·ªã">
        <input id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">

        <div class="modal-footer">
            <button onclick="closeAddModal()">H·ªßy</button>
            <button class="btn btn-add" onclick="submitAdd()">L∆∞u</button>
        </div>
    </div>
</div>

<!-- =========================== MODAL IMPORT EXCEL =============================== -->
<div id="importModal" class="modal-bg">
    <div class="modal-box">
        <h3 style="color:yellow;">Nh·∫≠p danh s√°ch t·ª´ Excel</h3>

        <form id="excelForm" enctype="multipart/form-data">
            <input type="file" name="excel_file" accept=".xlsx,.xls" required>
        </form>

        <div class="modal-footer">
            <button onclick="closeImportModal()">H·ªßy</button>
            <button class="btn btn-import" onclick="submitImport()">T·∫£i l√™n</button>
        </div>
    </div>
</div>

<!-- =========================== MODAL ƒê·ªîI M·∫¨T KH·∫®U =============================== -->
<div id="pwModal" class="modal-bg">
    <div class="modal-box">
        <h3>ƒê·ªïi m·∫≠t kh·∫©u ‚Äì <span id="pwUser" style="color:yellow;"></span></h3>

        <input id="newPw" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi">
        <input id="confirmPw" type="password" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">

        <div class="modal-footer">
            <button onclick="closePwModal()">H·ªßy</button>
            <button class="btn btn-add" onclick="submitPassword()">L∆∞u</button>
        </div>
    </div>
</div>

<script>
    const compId = {{ comp_id }};
    let currentUserId = null;

    /* ---------- M·ªü / ƒê√≥ng Modal Th√™m ---------- */
    function openAddModal() { document.getElementById("addModal").style.display = "flex"; }
    function closeAddModal() { document.getElementById("addModal").style.display = "none"; }

    /* ---------- M·ªü / ƒê√≥ng Modal Import ---------- */
    function openImportModal() { document.getElementById("importModal").style.display = "flex"; }
    function closeImportModal() { document.getElementById("importModal").style.display = "none"; }

    /* ---------- M·ªü / ƒê√≥ng Modal M·∫≠t kh·∫©u ---------- */
    function openPasswordModal(id, username) {
        currentUserId = id;
        document.getElementById("pwUser").textContent = username;
        document.getElementById("pwModal").style.display = "flex";
    }
    function closePwModal() { document.getElementById("pwModal").style.display = "none"; }

    /* ---------- API Th√™m th√≠ sinh ---------- */
    function submitAdd() {
        fetch(`/admin/competitions/${compId}/candidates/add`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                full_name: full_name.value,
                rank: rank.value,
                position: position.value,
                unit: unit.value,
                username: username.value,
                password: password.value
            })
        })
        .then(r => r.json())
        .then(d => {
            alert(d.message);
            if (d.status === "success") location.reload();
        });
    }

    /* ---------- API Import Excel ---------- */
    function submitImport() {
        const formData = new FormData(document.getElementById("excelForm"));

        fetch(`/admin/competitions/${compId}/candidates/import`, {
            method: "POST",
            body: formData
        })
        .then(r => r.json())
        .then(d => {
            alert(d.message);
            if (d.status === "success") location.reload();
        });
    }

    /* ---------- API X√≥a ---------- */
    function deleteCandidate(id, username) {
        if (!confirm(`X√≥a th√≠ sinh "${username}"?`)) return;

        fetch("/admin/candidates/delete", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ candidate_id: id })
        })
        .then(r => r.json())
        .then(d => {
            alert("ƒê√£ x√≥a!");
            location.reload();
        });
    }

    /* ---------- API ƒê·ªïi m·∫≠t kh·∫©u ---------- */
    function submitPassword() {
        if (newPw.value !== confirmPw.value) {
            alert("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng ƒë√∫ng!");
            return;
        }

        fetch("/admin/candidates/change_password", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ id: currentUserId, password: newPw.value })
        })
        .then(r => r.json())
        .then(d => {
            alert(d.message);
            if (d.status === "success") closePwModal();
        });
    }
</script>

<footer>
    ¬© H·ªá th·ªëng thi tr·∫Øc nghi·ªám - B·∫£n quy·ªÅn thu·ªôc Ban Th√¥ng tin ‚Äì S∆∞ ƒëo√†n 395.
</footer>

</body>
</html>
