<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh s√°ch ƒë·ªÅ thi</title>
    <style>
        /* Background v√† font t∆∞∆°ng t·ª± trang ng√¢n h√†ng c√¢u h·ªèi */
        body {
            font-family: Arial, sans-serif;
            margin: 60px auto 60px;
            max-width: 1200px;
            background: url('/static/img/Background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            min-height: 100vh;
            position: relative;
        }

        header {
            display: flex;
            align-items: center;
            background: #003200;
            padding: 10px 20px;
            border-bottom: 3px solid yellow;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        header img {
            height: 80px;
            margin-right: 15px;
        }
        header div {
            color: yellow;
        }
        header h1 {
            margin: 0;
            font-size: 25px;
            font-weight: bold;
        }
        header p {
            margin: 0;
            font-size: 18px;
            font-style: italic;
            color: #ffcc00;
        }

        footer {
            background: #003200;
            text-align: center;
            padding: 10px;
            color: #ccc;
            font-size: 14px;
            border-top: 3px solid yellow;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }

    </style>
</head>
<body>

<header>
    <img src="/static/img/LOGO_f395.png" alt="Logo">
    <div>
        <h1>S∆Ø ƒêO√ÄN B·ªò BINH 395</h1>
        <p>‚Äúƒêo√†n k·∫øt, ti·∫øn c√¥ng, luy·ªán gi·ªèi, ƒë√°nh th·∫Øng‚Äù</p>
    </div>
</header>

<h2 style="text-align:center; color:yellow; margin-top:20px;">Qu·∫£n tr·ªã ng∆∞·ªùi d√πng</h2>

<div style="display:flex; margin-top:30px; gap:30px;">

    <!-- ==================== C√ÇY ƒê∆†N V·ªä (TR√ÅI) ==================== -->
    <div style="width:30%; background:#002200; padding:20px; border-radius:10px; color:white; max-height:600px; overflow:auto;">
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
            ƒê∆°n v·ªã
            <span onclick="openCreateUnitModal(null)"
                style="cursor:pointer; color:yellow; font-size:22px;"
                title="Th√™m ƒë∆°n v·ªã l·ªõn">‚ûï</span>
        </h3>

        <ul id="unitTree" style="list-style:none; padding-left:0;">
            {% macro render_unit(unit) %}
            <li>
                <span style="display:flex; justify-content:space-between; align-items:center;">
                <span class="unit-item" data-id="{{ unit.unit_id }}" style="cursor:pointer;">
                    üìÅ {{ unit.unit_name }}
                </span>
                <span style="display:flex; gap:10px;">
                <!-- n√∫t t·∫°o ƒë∆°n v·ªã con -->
                <span onclick="openCreateUnitModal({{ unit.unit_id }})"
                    style="cursor:pointer; color:lightgreen; font-size:20px; margin-left:8px;"
                    title="Th√™m ƒë∆°n v·ªã con">
                    ‚ûï
                </span>
                <!-- N√∫t x√≥a ƒë∆°n v·ªã -->
                <span onclick="confirmDeleteUnit({{ unit.unit_id }}, '{{ unit.unit_name }}')"
                    style="cursor:pointer; color:red; font-size:20px; margin-left:8px;"
                    title="X√≥a ƒë∆°n v·ªã">üóë</span>
                </span>
                </span>
                {% if unit.children %}
                <ul style="margin-left:20px; list-style:none;">
                    {% for child in unit.children %}
                        {{ render_unit(child) }}
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endmacro %}

            {% for u in units_tree %}
                {{ render_unit(u) }}
            {% endfor %}
        </ul>
    </div>

    <!-- ==================== DANH S√ÅCH USER (GI·ªÆA) ==================== -->
    <div style="flex:1; background:#002200; padding:20px; border-radius:10px; color:white;">

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="unitTitle">Ch·ªçn ƒë∆°n v·ªã ƒë·ªÉ xem t√†i kho·∫£n</h3>

            <div>
                <a href="{{ url_for('create_user') }}" 
                   class="btn btn-warning"
                   style="margin-right:10px; font-weight:bold;">
                    ‚ûï T·∫°o t√†i kho·∫£n qu·∫£n tr·ªã
                </a>

                <a href="{{ url_for('create_user') }}"
                   class="btn btn-success"
                   style="font-weight:bold;">
                    ‚ûï T·∫°o t√†i kho·∫£n ng∆∞·ªùi d√πng
                </a>
            </div>
        </div>

        <hr style="border-color:#666;">

        <table style="width:100%; color:white; border-collapse:collapse;">
            <thead>
                <tr style="background:#004400;">
                    <th style="padding:8px;">ID</th>
                    <th style="padding:8px;">T√™n ƒëƒÉng nh·∫≠p</th>
                    <th style="padding:8px;">Quy·ªÅn</th>
                    <th style="padding:8px;">Tr·∫°ng th√°i</th>
                    <th style="padding:8px;">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody id="userList">
                <tr><td colspan="3" style="text-align:center;"><i>Ch∆∞a c√≥ d·ªØ li·ªáu</i></td></tr>
            </tbody>
        </table>

    </div>
</div>
<br><a href="{{ url_for('admin_dashboard') }}" style="color:red">‚Üê Quay l·∫°i Trang qu·∫£n tr·ªã</a>

<!-- ====================== MODAL T·∫†O ƒê∆†N V·ªä ====================== -->
<div id="unitModal"
     style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; 
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000;">
    
    <div style="background:#003300; padding:20px; border-radius:10px; width:350px; color:white;">

        <h3 style="text-align:center; color:yellow;">T·∫°o ƒë∆°n v·ªã m·ªõi</h3>

        <form id="unitForm">
            <input type="hidden" name="parent_id" id="parent_id">

            <label>T√™n ƒë∆°n v·ªã:</label><br>
            <input type="text" name="unit_name" id="unit_name" 
                   required style="width:100%; padding:5px; margin-top:5px;"><br><br>

            <button type="submit"
                    style="width:100%; padding:8px; font-weight:bold;">
                ‚úî T·∫°o ƒë∆°n v·ªã
            </button>
        </form>

        <div style="text-align:center; margin-top:10px;">
            <button onclick="closeUnitModal()" 
                    style="padding:5px 15px; background:gray; border:none; color:white;">
                H·ªßy
            </button>
        </div>
    </div>
</div>
<!-- ==================== MODEL X√ÅC NH·∫¨N X√ìA ƒê∆†N V·ªä ============= -->
 <div id="deleteUnitModal"
     style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:3000;">
    
    <div style="background:#330000; padding:20px; border-radius:10px; width:350px; color:white;">
        <h3 style="text-align:center; color:yellow;">X√°c nh·∫≠n x√≥a ƒë∆°n v·ªã</h3>

        <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë∆°n v·ªã <b><span id="deleteUnitName"></span></b> kh√¥ng?</p>

        <div style="text-align:right; margin-top:20px;">
            <button onclick="closeDeleteUnitModal()" style="padding:6px 14px;">H·ªßy</button>
            <button onclick="submitDeleteUnit()" style="padding:6px 14px; background:red; color:white; margin-left:10px;">
                X√≥a
            </button>
        </div>

        <input type="hidden" id="deleteUnitId">
    </div>
</div>

<!-- ==================== MODAL ƒê·ªîI M·∫¨T KH·∫®U ==================== -->
<div id="passwordModal" 
     style="
        display:none; 
        position:fixed; 
        top:0; left:0; right:0; bottom:0;
        background:rgba(0,0,0,0.6);
        justify-content:center;
        align-items:center;
     ">
    <div style="
        background:#003300; 
        padding:20px; 
        border-radius:10px; 
        width:350px;
        color:white;
    ">
        <h3>ƒê·ªïi m·∫≠t kh·∫©u cho <span id="pwUsername" style="color:yellow"></span></h3>

        <input id="newPw" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi" 
               style="width:100%; padding:8px; margin-top:10px;">

        <input id="confirmPw" type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" 
               style="width:100%; padding:8px; margin-top:10px;">

        <div style="margin-top:15px; text-align:right;">
            <button onclick="closePasswordModal()" style="margin-right:10px;">H·ªßy</button>
            <button onclick="submitPasswordChange()" style="background:yellow; color:black;">
                L∆∞u
            </button>
        </div>
    </div>
</div>


<script>
// API load user
function loadUsers(unitId) {   
    fetch(`/admin/get_users/${unitId}`)
        .then(res => res.json())
        .then(data => {
            let html = "";
            if (data.length === 0) {
                html = `<tr><td colspan="3" style="text-align:center;"><i>Kh√¥ng c√≥ t√†i kho·∫£n n√†o</i></td></tr>`;
            } else {
                data.forEach(u => {
                    html += `
                        <tr style="background:#003300;">
                            <td style="padding:8px;">${u.id}</td>
                            <td style="padding:8px;">${u.username}</td>
                            <td style="padding:8px;">${u.role}</td>
                            <td style="padding:8px; color:${u.status === 'active' ? 'lightgreen' : 'red'};">
                                ${u.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'ƒê√£ kh√≥a'}
                            </td>
                            <td style="padding:8px;">
                                <button onclick="toggleStatus(${u.id}, '${u.status}')" 
                                        style="padding:5px; cursor:pointer;">
                                    ${u.status === 'active' ? 'Kh√≥a' : 'M·ªü kh√≥a'}
                                </button>
                                <button onclick="openPasswordModal(${u.id}, '${u.username}')">
                                    üîë ƒê·ªïi m·∫≠t kh·∫©u
                                </button>
                                <button onclick="deleteUser(${u.id}, '${u.username}')" style="background:red; color:white;">
                                    üóë X√≥a
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            document.getElementById("userList").innerHTML = html;
        });
    }
// ========================== CLICK ƒê∆†N V·ªä ==============================
document.querySelectorAll(".unit-item").forEach(item => {
    item.addEventListener("click", function () {
        const unitId = this.dataset.id;
        const unitName = this.textContent.trim();

        // Highlight
        document.querySelectorAll(".unit-item").forEach(el => el.style.color = "white");
        this.style.color = "yellow";

        // Hi·ªÉn th·ªã t√™n ƒë∆°n v·ªã
        document.getElementById("unitTitle").innerText = "T√†i kho·∫£n c·ªßa ƒë∆°n v·ªã: " + unitName;
        
        // L∆∞u ƒë∆°n v·ªã ƒëang ch·ªçn v√†o session
        fetch("/admin/set_active_unit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ unit_id: unitId })
        })
        .then(res => res.json())
        .then(resp => {
        console.log("Saved unit:", resp);
        })
        .catch(err => console.error("Error saving unit:", err));

    
        sessionStorage.setItem("active_unit", unitId);
        loadUsers(unitId);
    });
});

// M·ªü modal - parentId = null => ƒë∆°n v·ªã l·ªõn
function openCreateUnitModal(parentId) {
    document.getElementById("parent_id").value = parentId ?? "";
    document.getElementById("unit_name").value = "";
    document.getElementById("unitModal").style.display = "flex";
}

// ƒê√≥ng modal
function closeUnitModal() {
    document.getElementById("unitModal").style.display = "none";
}

// G·ª≠i ƒë∆°n v·ªã l√™n server
document.getElementById("unitForm").addEventListener("submit", function(e) {
    e.preventDefault();

    fetch("/admin/create_unit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            unit_name: document.getElementById("unit_name").value,
            parent_id: document.getElementById("parent_id").value
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);

        if (data.success) {
            location.reload();   // t·∫£i l·∫°i trang ƒë·ªÉ th·∫•y ƒë∆°n v·ªã m·ªõi
        }
    });
});

// G·ªçi API kh√≥a/m·ªü kh√≥a
function toggleStatus(userId, currentStatus) {
    fetch("/admin/toggle_user_status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, current_status: currentStatus })
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === "success") {
            // reload l·∫°i ƒë∆°n v·ªã ƒëang ch·ªçn
            document.querySelector(".unit-item[style*='color: yellow']")?.click();
        }
    }); 
}
// =============================== X√ìA ƒê∆†N V·ªä ======================================
// M·ªü modal x√°c nh·∫≠n x√≥a ƒë∆°n v·ªã
function confirmDeleteUnit(unitId, unitName) {
    document.getElementById("deleteUnitId").value = unitId;
    document.getElementById("deleteUnitName").innerText = unitName;
    document.getElementById("deleteUnitModal").style.display = "flex";
}

// ƒê√≥ng modal
function closeDeleteUnitModal() {
    document.getElementById("deleteUnitModal").style.display = "none";
}

// G·ª≠i API x√≥a ƒë∆°n v·ªã
function submitDeleteUnit() {
    const id = document.getElementById("deleteUnitId").value;

    fetch("/admin/delete_unit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ unit_id: id })
    })
    .then(res => res.json())
    .then(resp => {
        alert(resp.message);
        if (resp.success) {
            location.reload();   // Reload ƒë·ªÉ c·∫≠p nh·∫≠t c√¢y ƒë∆°n v·ªã
        }
    });
}

// =============================== ƒê·ªîI M·∫¨T KH·∫®U ==========================================
let currentUserId = null;

// M·ªü modal
function openPasswordModal(userId, username) {
    currentUserId = userId;
    document.getElementById("pwUsername").innerText = username;
    document.getElementById("newPw").value = "";
    document.getElementById("confirmPw").value = "";
    document.getElementById("passwordModal").style.display = "flex";
}

// ƒê√≥ng modal
function closePasswordModal() {
    document.getElementById("passwordModal").style.display = "none";
}

// G·ª≠i y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u
function submitPasswordChange() {
    const pw = document.getElementById("newPw").value.trim();
    const confirm = document.getElementById("confirmPw").value.trim();

    // if (pw.length < 4) {
    //     alert("M·∫≠t kh·∫©u ph·∫£i d√†i √≠t nh·∫•t 4 k√Ω t·ª±!");
    //     return;
    // }
    if (pw !== confirm) {
        alert("M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!");
        return;
    }

    fetch("/admin/change_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: currentUserId, password: pw })
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === "success") {
            alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
            closePasswordModal();
        } else {
            alert("L·ªói: " + resp.message);
        }
    });
}

// ============================ X√ìA T√ÄI KHO·∫¢N ===============================
function deleteUser(userId, username) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n "${username}"?`)) {
        return;
    }

    fetch("/admin/delete_user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId })
    })
    .then(res => res.json())
    .then(resp => {
        if (resp.status === "success") {
            alert("ƒê√£ x√≥a t√†i kho·∫£n!");
            // // T·∫£i l·∫°i danh s√°ch t√†i kho·∫£n c·ªßa ƒë∆°n v·ªã ƒëang ch·ªçn
            // const activeUnit = sessionStorage.getItem("active_unit");
            // if (activeUnit) loadUsers(activeUnit);

            // üî• L·∫•y l·∫°i ƒë∆°n v·ªã ƒëang ch·ªçn (ƒë√£ l∆∞u khi click)
            const unitId = sessionStorage.getItem("active_unit");

            // üî• T·∫£i l·∫°i danh s√°ch t√†i kho·∫£n
            if (unitId) loadUsers(unitId);
        } else {
            alert("L·ªói: " + resp.message);
        }
    })
    .catch(err => console.error("L·ªói x√≥a user:", err));
}
</script>

<footer>
    ¬© H·ªá th·ªëng thi tr·∫Øc nghi·ªám - B·∫£n quy·ªÅn ph·∫ßn m·ªÅm thu·ªôc v·ªÅ Ban Th√¥ng tin - Ph√≤ng Tham m∆∞u - S∆∞ ƒëo√†n 395.
</footer>

</body>
</html>
