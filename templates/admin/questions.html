<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Ng√¢n h√†ng c√¢u h·ªèi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: url('/static/img/Background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* justify-content: center; */
        }

         header {
                display: flex;
                align-items: center;
                background: #003200;
                padding: 10px 20px;
                border-bottom: 3px solid yellow;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            header img {
                height: 80px;
                margin-right: 15px;
            }
            header div {
                color: yellow;
            }
            header h1 {
                margin: 0;
                font-size: 25px;
                font-weight: bold;
            }
            header p {
                margin: 0;
                font-size: 18px;
                font-style: italic;
                color: #ffcc00;
            }

        footer {
            background: #003200;
            text-align: center;
            padding: 10px;
            color: #ccc;
            font-size: 14px;
            border-top: 3px solid yellow;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        main {
            flex: 1;
            max-width: 1300px;
            margin: 80px auto 80px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            color: white;
        }

        h1, h2, h3 {
            text-align: left;
            color: #ffcc00;
            margin-top: 0;
        }

        form label {
            font-weight: bold;
            display: block;
            margin-top: 5px;
            color: #ffcc00;
        }
        form textarea, form input[type="text"], form select {
        width: 100%;
        max-width: 1200px; /* chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho c√°c √¥ */
        padding: 8px;
        border-radius: 5px;
        border: none;
        margin-top: 5px;
        box-sizing: border-box;
    }
        form button {
            margin-top: 20px;
            padding: 12px 25px;
            background: #006600;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        form button:hover {
            background: #009900;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 50, 0, 0.9);
            border-radius: 8px;
            overflow: hidden;
        }
        table thead tr {
            background-color: #004d00;
        }
        table th, table td {
            padding: 10px 12px;
            border: 1px solid #006600;
            text-align: left;
        }
        table tbody tr:hover {
            background-color: rgba(102, 255, 102, 0.2);
            cursor: pointer;
        }
        table tbody tr td form {
            margin: 0;
        }
        table tbody tr td form button {
            background: #cc3300;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        table tbody tr td form button:hover {
            background: #ff3300;
        }

        a.back-link {
            display: inline-block;
            margin-top: 20px;
            color: #ffcc00;
            font-weight: bold;
            text-decoration: none;
        }
        a.back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<header>
    <img src="/static/img/LOGO_f395.png" alt="Logo">
    <div>
        <h1>S∆Ø ƒêO√ÄN B·ªò BINH 395</h1>
        <p>‚Äúƒêo√†n k·∫øt, ti·∫øn c√¥ng, luy·ªán gi·ªèi, ƒë√°nh th·∫Øng‚Äù</p>
    </div>
</header>

<main>

    <!-- Tin nh·∫Øn flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}
    <h1 style="text-align: center; margin-top: 10px;">üìö Ng√¢n h√†ng c√¢u h·ªèi</h1>
        <!-- Form upload Excel -->
    <form action="/admin/questions/import" method="post" enctype="multipart/form-data">
        <label>Nh·∫≠p c√¢u h·ªèi t·ª´ Excel:</label>
        <!--File m·∫´u excel-->
        üì• <a href="{{ url_for('static', filename='sample_questions.xlsx') }}" download>
            T·∫£i file Excel m·∫´u
        </a>
        <br>
        <!-- <form action="{{ url_for('questions_bp.import_questions') }}" method="POST" enctype="multipart/form-data"> -->
        <input type="file" name="excel_file" accept=".xlsx,.xls" required>
        <input type="hidden" name="subject_id" id="hiddenSubjectId">
        <button type="submit">üìÇ T·∫£i l√™n</button>
        <!-- </form> -->
    </form>
    <hr>
        <form method="get" action="/admin/questions"
             style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
            <label for="subject_id">M√¥n h·ªçc:</label>
            <select name="subject_id" id="subjectSelect">
                <option value="">T·∫•t c·∫£ m√¥n</option>
                {% for s in subjects %}
                    <option value="{{ s['id'] }}" {% if  request.args.get("subject_id") == s["id"]|string %}selected{% endif %}>
                        {{ s['subject_name'] }}
                    </option>
                    <!-- <option value="{{ s.id }}">{{ s.subject_name }}</option> -->
                {% endfor %}
            </select>
            <!-- üî• N√∫t t·∫°o m√¥n h·ªçc m·ªõi -->
            <button type="button" onclick="openSubjectModal()" 
                    style="padding:6px 12px; background:yellow; font-weight:bold; cursor:pointer;">
                ‚ûï T·∫°o m√¥n h·ªçc
            </button>
        </form>
        <!-- ‚ùå X√≥a m√¥n -->
            <button type="button"
                    onclick="deleteSubject()"
                    style="padding:6px 12px; background:red; color:white; font-weight:bold;">
                ‚ùå X√≥a m√¥n h·ªçc
            </button>
        <form method="post" action="/admin/questions">
            <!-- üî• GI·ªÆ M√îN H·ªåC ƒêANG CH·ªåN -->
            <label for="content" style="margin-left: 50px;">Nh·∫≠p n·ªôi dung c√¢u h·ªèi:</label>
            <div style="text-align: center;">
            <textarea id="content" name="content" required></textarea>
            </div>

            <label for="a" style="margin-left: 50px;">A:</label>
            <div style="text-align: center;">
            <input type="text" id="a" name="a" required>
            </div>
            
            <label for="b"style="margin-left: 50px;">B:</label>
            <div style="text-align: center;">
            <input type="text" id="b" name="b" required>
            </div>

            <label for="c"style="margin-left: 50px;">C:</label>
            <div style="text-align: center;">
            <input type="text" id="c" name="c" required>
            </div>

            <label for="d"style="margin-left: 50px;">D:</label>
            <div style="text-align: center;">
            <input type="text" id="d" name="d" required>
            </div>
            
            <label for="correct" style="margin-left: 50px;">ƒê√°p √°n ƒë√∫ng:</label>
            <select id="correct" name="correct" style="width:300px; margin-left: 50px;" required>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
            </select>
            
            <br>
            <button type="submit"style="margin-left: 50px;">Th√™m c√¢u h·ªèi</button>
        </form>
        <br>
    <hr>
        <h1 style="text-align: center;">Danh s√°ch c√¢u h·ªèi</h1>
        
        <!-- L·ªçc c√¢u h·ªèi theo m√¥n -->
         <form method="get" action="/admin/questions">
            <select name="subject_filter" id="subject_filter">
                <option value="{{ subjects }}">T·∫•t c·∫£ m√¥n</option>
                {% for s in subjects %}
                    <option value="{{ s["id"] }}" {% if  request.args.get("subject_filter") == s["id"]|string %}selected{% endif %}>
                        {{ s['subject_name'] }}
                    </option>
                {% endfor %}
            </select>
        </form>

        <!-- Form t√¨m ki·∫øm -->
        <form method="get" action="{{ url_for('questions_bp.question_list') }}" style="margin-bottom: 15px;">
            <label for="t√¨m ki·∫øm">T√¨m ki·∫øm:</label>
            <input type="text" name="keyword" placeholder=" Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." 
                value="{{ keyword if keyword else '' }}" 
                style="padding:8px; width:300px; border-radius:5px; border:1px solid #ccc;">
            <button type="submit" style="padding:8px 15px; background:#90f0cd; color:white; border:none; border-radius:5px; cursor:pointer;">üîç</button>
        </form>

        <!-- N√∫t quay l·∫°i trang qu·∫£n tr·ªã v√† n√∫t x√≥a t·∫•t c·∫£ c√¢u h·ªèi -->
        <form action="{{ url_for('questions_bp.delete_all_questions') }}" method="POST"
            onsubmit="return confirm('‚ö† B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ c√¢u h·ªèi kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!');">
            <button type="submit" style="background:#cc0000; color:white; font-weight:bold; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; margin-bottom:10px;">
                üóë X√≥a t·∫•t c·∫£ c√¢u h·ªèi
            </button>
        </form>

        <button style="background:#c2db48; color:white; padding:10px 20px; border-radius:6px;">
            <a href="{{ url_for('dashboard_bp.admin_dashboard') }}" >‚Üê Quay l·∫°i Trang qu·∫£n tr·ªã</a>
        </button>

        <!-- <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>N·ªôi dung c√¢u h·ªèi</th>
                    <th>A</th>
                    <th>B</th>
                    <th>C</th>
                    <th>D</th>
                    <th>ƒê√°p √°n ƒë√∫ng</th>
                    <th>S·ª≠a</th>
                    <th>X√≥a</th>
                </tr>
            </thead>
            <tbody>
                {% for q in questions %}
                <tr>
                    <td>{{ q['id'] }}</td>
                    <td>{{ q['content'] }}</td>
                    <td>{{ q['option_a'] }}</td>
                    <td>{{ q['option_b'] }}</td>
                    <td>{{ q['option_c'] }}</td>
                    <td>{{ q['option_d'] }}</td>
                    <td>{{ q['correct_option'] }}</td>
                    <td><a href="{{ url_for('questions_bp.edit_question', question_id=q['id']) }}" style="color:#ccff33; font-weight:bold;">S·ª≠a</a></td>
                    <td>
                        <form action="{{ url_for('questions_bp.delete_question', question_id=q['id']) }}" method="POST" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¢u h·ªèi n√†y?');">
                            <button type="submit">X√≥a</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="9" style="color:#ffcc00; text-align:center;">Ch∆∞a c√≥ c√¢u h·ªèi n√†o.</td></tr>
                {% endfor %}
            </tbody>
        </table> -->
        <table style="width:100%; border-collapse:collapse; background:#002200; color:white;">
    <thead>
        <tr style="background:#004400;">
            <th style="padding:8px;">ID</th>
            <th style="padding:8px; width:35%;">N·ªôi dung c√¢u h·ªèi</th>
            <th style="padding:8px;">A</th>
            <th style="padding:8px;">B</th>
            <th style="padding:8px;">C</th>
            <th style="padding:8px;">D</th>
            <th style="padding:8px;">ƒê√°p √°n</th>
            <th style="padding:8px;">H√†nh ƒë·ªông</th>
        </tr>
    </thead>

    <!-- üî• JS s·∫Ω render d·ªØ li·ªáu v√†o ƒë√¢y -->
    <tbody id="questionTable">
        <tr>
            <td colspan="8" style="text-align:center; padding:20px;">
                <i>Vui l√≤ng ch·ªçn m√¥n h·ªçc ƒë·ªÉ xem c√¢u h·ªèi</i>
            </td>
        </tr>
    </tbody>
</table>

</main>

<!-- ================== MODAL T·∫†O M√îN H·ªåC ================== -->
<div id="subjectModal"
     style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">

    <div style="background:#003300; color:white; padding:20px; border-radius:10px; width:350px;">
        <h3 style="text-align:center; color:yellow;">T·∫°o m√¥n h·ªçc m·ªõi</h3>

        <input id="subjectName" type="text" placeholder="T√™n m√¥n h·ªçc"
               style="width:100%; padding:8px; margin-top:10px;">

        <div style="margin-top:15px; text-align:right;">
            <button onclick="closeSubjectModal()" style="margin-right:10px;">H·ªßy</button>
            <button onclick="submitSubject()" style="background:yellow; color:black;">L∆∞u</button>
        </div>
    </div>
</div>

<script>
function openSubjectModal() {
    document.getElementById("subjectModal").style.display = "flex";
}

function closeSubjectModal() {
    document.getElementById("subjectModal").style.display = "none";
}

function submitSubject() {
    const name = document.getElementById("subjectName").value.trim();
    if (!name) {
        alert("Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc!");
        return;
    }

    fetch("/admin/subjects/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ subject_name: name })
    })
    .then(res => res.json())
    .then(resp => {
        alert(resp.message);
        if (resp.status === "success") location.reload();
    });
}
// ===== ch·ªçn m√¥n h·ªçc khi t·∫°o c√¢u h·ªèi m·ªõi ========
subjectSelect.addEventListener("change", function () {
    fetch("/admin/questions/set_active_subject", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            subject_id: this.value
        })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Active subject saved:", data.subject_id);
    });
});
// ===== Gi·ªØ m√¥n ƒëang ch·ªçn sau khi load l·∫°i trang ========
const activeSubject = "{{ session.get('active_subject_id', '') }}";
if (activeSubject) {
    document.getElementById("subjectSelect").value = activeSubject;
}
// ===== load c√¢u h·ªèi theo m√¥n (kh√¥ng reload) ========
document.getElementById("subject_filter").addEventListener("click", function () {
    const subjectFilter = this.value;
    fetch(`/admin/questions/api`,{
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ subjectFilter: subjectFilter })
        })
        .then(res => res.json())
        .then(data => {
        let html = "";

    if (data.length === 0) {
        html = `
            <tr>
                <td colspan="8" style="text-align:center;">
                    <i>Kh√¥ng c√≥ c√¢u h·ªèi</i>
                </td>
            </tr>
        `;
    } else {
        data.forEach(q => {
            html += `
                <tr>
                    <td>${q.id}</td>
                    <td>${q.content}</td>
                    <td>${q.option_a}</td>
                    <td>${q.option_b}</td>
                    <td>${q.option_c}</td>
                    <td>${q.option_d}</td>
                    <td style="text-align:center; font-weight:bold; color:#ffcc00;">
                        ${q.correct_option}
                    </td>
                    <td style="text-align:center;">
                        <a href="/admin/questions/edit/${q.id}" style="color:#ccff33; font-weight:bold;">S·ª≠a</a>
                        |
                        <button onclick="deleteQuestion(${q.id})"
                                style="background:none; color:red; border:none; cursor:pointer;">
                            X√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    document.getElementById("questionTable").innerHTML = html;
        });
});
// ====== X√≥a m√¥n h·ªçc ==============
function deleteSubject() {
    const subjectId = document.getElementById("subjectSelect").value;

    let message = subjectId
        ? "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√¥n h·ªçc n√†y?"
        : "‚ö† B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò M√îN H·ªåC?";

    if (!confirm(message)) return;

    fetch("/admin/subjects/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ subject_id: subjectId })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        if (data.success) location.reload();
    });
}
</script>

<footer>¬© H·ªá th·ªëng thi tr·∫Øc nghi·ªám - B·∫£n quy·ªÅn ph·∫ßn m·ªÅm thu·ªôc v·ªÅ Ban Th√¥ng tin - Ph√≤ng Tham m∆∞u - S∆∞ ƒëo√†n 395.</footer>

</body>
</html>
